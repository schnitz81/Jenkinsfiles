pipeline {
	agent any 

	stages {
		stage('Clean workspace') {
			steps {
    	        deleteDir();
			}
		}
		stage('Checking gcc availability') {
			steps {
				script {
					if(fileExists('/usr/bin/gcc')) {
						echo 'gcc found'
					} else {
						echo 'Error: Cant find gcc.'
						Environment.Exit(1)
					}
				}
			}
		}
		stage('Checking curses availability') {
				steps {
				script {
					if(fileExists('/usr/include/curses.h')) {
						echo 'curses found.'
					} else {
						echo 'Error: Cant find curses.'
						Environment.Exit(1)
					}
				}
			}
		}
		stage('Checkout repo') {
			steps {
				echo 'Cloning beings repo'
				git url: 'https://github.com/schnitz81/beings.git'
			}
		}
        stage('Compile') {
			steps {
				echo 'Compiling...'
				sh 'gcc -v -Wall -c ai.c'
				sh 'gcc -v -Wall -c being.c'
				sh 'gcc -v -Wall -c event.c'
				sh 'gcc -v -Wall -c main.c'
				sh 'gcc -v -Wall -c world.c'
				sh 'gcc -v -o beings main.o ai.o event.o being.o world.o -lcurses'
			}
		}
		stage('Test of binary existance') {
			steps {
				echo 'Checking if file exists'
				fileExists('beings')
			}
		}
		stage('Stash binary and repo files') {
			steps {
				stash includes: 'beings', name: 'binary'
				stash includes: 'icon.png', name: 'icon'
				stash includes: 'beings.desktop', name: 'desktop'
				stash includes: 'AppRun', name: 'apprun'
			}
		}
		stage('Clean workspace before appImage deps preparation') {
			steps {
    	        deleteDir();
			}
		}
		stage('Checkout of appImage deps') {
			steps {
				echo 'Cloning Jenkins repo'
				git url: 'https://github.com/schnitz81/Jenkinsfiles.git'
			}
		}
		stage('Create appImage fs') {
			steps {
				echo "Creating fs for appImage"
				sh 'mkdir -pv beings-appfs/lib64'
				sh 'mkdir -pv beings-appfs/usr/bin'
			}
		}
		stage('Solve and copy lib dependencies') {
			steps {
				echo "Copying libs..." 
				sh "noOfLibs=`ldd beings | grep -ce '\\/lib\\(.*\\)\\ '`"
				sh "echo $noOfLibs"
				sh "for i in `seq 1 $noOfLibs`; do cp -v `ldd beings | grep -oe '\/lib\(.*\)\ ' | head -n $i | tail -n 1` beings-appfs/lib64/"
			}
		}
		stage('Unstash binary') {
			steps {
				dir('/tmp/') {
					unstash 'binary'
				}
			}
		}

    }
}
